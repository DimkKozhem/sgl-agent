# üõ°Ô∏è Fallback –º–µ—Ö–∞–Ω–∏–∑–º –≤ SQL-agent

## –ß—Ç–æ —Ç–∞–∫–æ–µ Fallback?

**Fallback (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º "–æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏", –∫–æ–≥–¥–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π.

**–§–∏–ª–æ—Å–æ—Ñ–∏—è:** –õ—É—á—à–µ –≤—ã–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 80%, —á–µ–º —É–ø–∞—Å—Ç—å —Å –æ—à–∏–±–∫–æ–π.

---

## üéØ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Fallback?

### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ Fallback:

```python
# –ö–æ–¥ –ë–ï–ó fallback
def extract_table_name(ddl: str):
    parsed = sqlglot.parse_one(ddl)  # ‚Üê –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å!
    return parsed.find(sqlglot.exp.Table).name

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ –ù–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º SQL: —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
# ‚ùå –ù–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º SQL: CRASH ‚Üí 500 Internal Server Error
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí —Å–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç
- –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å ‚Üí —Å–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ SQL ‚Üí sqlglot –º–æ–∂–µ—Ç –∑–∞–ø—É—Ç–∞—Ç—å—Å—è ‚Üí —Å–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç

### –° Fallback:

```python
# –ö–æ–¥ –° fallback
def extract_table_name(ddl: str):
    try:
        # –ü—Ä–æ–±—É–µ–º SQLglot (—Ç–æ—á–Ω—ã–π –º–µ—Ç–æ–¥)
        parsed = sqlglot.parse_one(ddl)
        return parsed.find(sqlglot.exp.Table).name
    except Exception:
        # Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º regex (–º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–π, –Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–π)
        match = re.search(r'CREATE TABLE (\w+)', ddl)
        return match.group(1) if match else None

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ –ù–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º SQL: —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ SQLglot (95% —Ç–æ—á–Ω–æ—Å—Ç—å)
# ‚úÖ –ù–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º SQL: —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ regex (70% —Ç–æ—á–Ω–æ—Å—Ç—å)
# ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç!
```

---

## üèóÔ∏è 3 —É—Ä–æ–≤–Ω—è Fallback –≤ SQL-agent

```
–£–†–û–í–ï–ù–¨ 1: SQLglot (—Ç–æ—á–Ω—ã–π, AST-based)
   ‚Üì fallback (–µ—Å–ª–∏ —É–ø–∞–ª)
–£–†–û–í–ï–ù–¨ 2: Regex (–º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–π, pattern-based)
   ‚Üì fallback (–µ—Å–ª–∏ —É–ø–∞–ª)
–£–†–û–í–ï–ù–¨ 3: –ü—Ä–æ—Å—Ç—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ (–±–∞–∑–æ–≤—ã–π)
```

---

## üìã –ü—Ä–∏–º–µ—Ä—ã Fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤

### 1Ô∏è‚É£ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã

**–§–∞–π–ª:** `sql_agent/llm_analyzer.py:590-611`

```python
def _extract_table_name_robust(self, ddl: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–º—è —Ç–∞–±–ª–∏—Ü—ã —Å —É—á–µ—Ç–æ–º –∫–∞–≤—ã—á–µ–∫ –∏ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤."""
    
    # –£–†–û–í–ï–ù–¨ 1: –ü—Ä–æ–±—É–µ–º SQLglot
    if self.enable_sql_parsing:
        try:
            parsed = sqlglot.parse_one(ddl, dialect="trino")
            table = parsed.find(sqlglot.exp.Table)
            if table:
                return table.name  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 99%
        except Exception as e:
            logger.debug(f"sqlglot parse failed, fallback to regex: {e}")
    
    # –£–†–û–í–ï–ù–¨ 2: Fallback –Ω–∞ regex
    match = re.search(
        r'CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?'
        r'(?:(?:`|")?(\w+)(?:`|")?\.)?'  # catalog (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        r'(?:(?:`|")?(\w+)(?:`|")?\.)?'  # schema (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        r'(?:`|")?(\w+)(?:`|")?',        # table
        ddl,
        re.IGNORECASE
    )
    if match:
        return match.group(3) or match.group(2) or match.group(1)  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 80%
    
    # –£–†–û–í–ï–ù–¨ 3: –ù–µ –Ω–∞—à–ª–∏
    return None  # ‚Üê –ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è, –Ω–æ —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```sql
-- –ü—Ä–∏–º–µ—Ä 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL
CREATE TABLE mydb.public.users (id INT, name VARCHAR(100))

SQLglot: ‚úÖ "users" (—Ç–æ—á–Ω–æ—Å—Ç—å 100%)
Regex:   ‚úÖ "users" (—Ç–æ—á–Ω–æ—Å—Ç—å 100%)

-- –ü—Ä–∏–º–µ—Ä 2: –° –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
CREATE TABLE /* comment */ mydb.public.users (id INT)

SQLglot: ‚ö†Ô∏è –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å ‚Üí fallback
Regex:   ‚úÖ "users" (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)

-- –ü—Ä–∏–º–µ—Ä 3: –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
CREATE TABLE `my-table-with-dashes` (id INT)

SQLglot: ‚ö†Ô∏è –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å ‚Üí fallback
Regex:   ‚ö†Ô∏è –ú–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ ‚Üí None
```

---

### 2Ô∏è‚É£ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ DDL

**–§–∞–π–ª:** `sql_agent/llm_analyzer.py:613-660`

```python
def _extract_columns_robust(self, ddl: str) -> List[Tuple[str, str]]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ —Å —É—á–µ—Ç–æ–º –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä."""
    
    # –£–†–û–í–ï–ù–¨ 1: SQLglot (—Ç–æ—á–Ω—ã–π)
    if self.enable_sql_parsing:
        try:
            parsed = sqlglot.parse_one(ddl, dialect="trino")
            columns = []
            
            for col_def in parsed.find_all(sqlglot.exp.ColumnDef):
                col_name = col_def.this.name
                col_type = col_def.kind.sql(dialect="trino")
                columns.append((col_name, col_type))
            
            if columns:
                return columns  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 99%
        except Exception as e:
            logger.debug(f"sqlglot failed, fallback to regex: {e}")
    
    # –£–†–û–í–ï–ù–¨ 2: Regex (—Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
    match = re.search(r'\(([^)]+(?:\([^)]*\)[^)]*)*)\)', ddl)
    if not match:
        return []
    
    columns_text = match.group(1)
    
    # –ü–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ split —Å —É—á–µ—Ç–æ–º –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–∫–æ–±–æ–∫
    columns = []
    current_col = []
    depth = 0
    
    for char in columns_text + ',':
        if char == '(':
            depth += 1
        elif char == ')':
            depth -= 1
        elif char == ',' and depth == 0:
            col_str = ''.join(current_col).strip()
            if col_str:
                parts = col_str.split(None, 1)
                if len(parts) >= 2:
                    columns.append((parts[0], parts[1]))
            current_col = []
            continue
        current_col.append(char)
    
    return columns  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 85%
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```sql
-- –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã
CREATE TABLE users (
    id INTEGER,
    name VARCHAR(100),
    created_at DATE
)

SQLglot: ‚úÖ [("id", "INTEGER"), ("name", "VARCHAR(100)"), ("created_at", "DATE")]
Regex:   ‚úÖ [("id", "INTEGER"), ("name", "VARCHAR(100)"), ("created_at", "DATE")]

-- –ü—Ä–∏–º–µ—Ä 2: –°–ª–æ–∂–Ω—ã–µ —Ç–∏–ø—ã
CREATE TABLE events (
    id INT,
    data MAP<VARCHAR, ARRAY<ROW(x INT, y VARCHAR)>>
)

SQLglot: ‚úÖ [("id", "INT"), ("data", "MAP<VARCHAR, ARRAY<ROW(x INT, y VARCHAR)>>")]
Regex:   ‚úÖ [("id", "INT"), ("data", "MAP<VARCHAR, ARRAY<ROW(x INT, y VARCHAR)>>")] 
         (–±–ª–∞–≥–æ–¥–∞—Ä—è —É—á–µ—Ç—É –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–∫–æ–±–æ–∫!)

-- –ü—Ä–∏–º–µ—Ä 3: –° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ (constraints)
CREATE TABLE users (
    id INT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL
)

SQLglot: ‚úÖ [("id", "INT"), ("email", "VARCHAR(255)")]
Regex:   ‚ö†Ô∏è [("id", "INT"), ("email", "VARCHAR(255) UNIQUE NOT NULL")]
         (–º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å constraints –≤ —Ç–∏–ø)
```

---

### 3Ô∏è‚É£ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤

**–§–∞–π–ª:** `sql_agent/llm_analyzer.py:805-836`

```python
def _optimize_single_query(...):
    # –£–†–û–í–ï–ù–¨ 1: –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ SQLglot
    try:
        parsed = sqlglot.parse_one(query, dialect="trino")
        
        # SELECT * ‚Üí –∫–æ–ª–æ–Ω–∫–∏
        self._replace_select_star_sqlglot(parsed, table_metadata)
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
        if not self._has_limit(parsed):
            parsed = self._add_limit_sqlglot(parsed, 10000)
        
        # –ê–Ω–∞–ª–∏–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π
        partition_used = self._check_partition_usage(parsed, table_metadata)
        
        # –ê–Ω–∞–ª–∏–∑ JOIN
        cluster_joins = self._check_cluster_joins(parsed, table_metadata)
        
        return parsed.sql(dialect="trino")  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 95%
        
    except Exception as e:
        logger.warning(f"SQL optimization failed, using simple approach: {e}")
        # –£–†–û–í–ï–ù–¨ 2: –ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (regex)
        return self._apply_simple_optimizations(query)

def _apply_simple_optimizations(self, query: str) -> str:
    """–ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–µ–∑ sqlglot."""
    optimized = query
    
    # –î–æ–±–∞–≤–ª—è–µ–º LIMIT –µ—Å–ª–∏ –Ω–µ—Ç
    if "LIMIT" not in optimized.upper():
        if not self._is_aggregation_query(optimized):
            optimized = optimized.rstrip(';') + "\nLIMIT 10000;"
    
    return optimized  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 50%
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```sql
-- –ü—Ä–∏–º–µ—Ä 1: SQLglot —É—Å–ø–µ—à–µ–Ω
SELECT * FROM users WHERE created_at > '2024-01-01'

SQLglot: ‚úÖ SELECT id, name, email FROM users WHERE created_at >= DATE '2024-01-01' LIMIT 10000
Fallback: (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

-- –ü—Ä–∏–º–µ—Ä 2: SQLglot –ø–∞–¥–∞–µ—Ç
SELECT /* very complex */ * FROM table1 LATERAL VIEW explode(...) AS t

SQLglot: ‚ùå –ü–∞–¥–∞–µ—Ç –Ω–∞ —Å–ª–æ–∂–Ω–æ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–µ
Fallback: ‚úÖ SELECT /* very complex */ * FROM table1 LATERAL VIEW explode(...) AS t LIMIT 10000
         (–ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç LIMIT, –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
```

---

### 4Ô∏è‚É£ –ó–∞–º–µ–Ω–∞ –ø—É—Ç–µ–π —Ç–∞–±–ª–∏—Ü

**–§–∞–π–ª:** `sql_agent/llm_analyzer.py:952-991`

```python
def _replace_table_paths_robust(self, query, catalog_name, schema_name):
    # –£–†–û–í–ï–ù–¨ 1: SQLglot (—Ç–æ—á–Ω—ã–π)
    if self.enable_sql_parsing:
        try:
            parsed = sqlglot.parse_one(query, dialect="trino")
            
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
            for table in parsed.find_all(sqlglot.exp.Table):
                if table.catalog and table.db:
                    if not table.db.this.startswith("optimized_"):
                        # –ó–∞–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É
                        table.set("db", sqlglot.exp.Identifier(this=schema_name))
                        table.set("catalog", sqlglot.exp.Identifier(this=catalog_name))
            
            return parsed.sql(dialect="trino")  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 99%
            
        except Exception as e:
            logger.debug(f"sqlglot path replacement failed, fallback to regex: {e}")
    
    # –£–†–û–í–ï–ù–¨ 2: Regex fallback
    pattern = r'(\w+)\.(\w+)\.(\w+)'  # catalog.schema.table
    
    def replace_path(match):
        cat, old_schema, table = match.groups()
        if not old_schema.startswith('optimized_'):
            return f"{catalog_name}.{schema_name}.{table}"
        return match.group(0)
    
    return re.sub(pattern, replace_path, query)  # ‚Üê –¢–æ—á–Ω–æ—Å—Ç—å 85%
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```sql
-- –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
SELECT * FROM mydb.public.users

SQLglot: ‚úÖ SELECT * FROM mydb.optimized_20241019.users
Regex:   ‚úÖ SELECT * FROM mydb.optimized_20241019.users

-- –ü—Ä–∏–º–µ—Ä 2: –° JOIN
SELECT o.*, u.name 
FROM orders o 
JOIN users u ON o.user_id = u.id

SQLglot: ‚úÖ –ó–∞–º–µ–Ω—è–µ—Ç –í–°–ï —Ç–∞–±–ª–∏—Ü—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (orders, users)
Regex:   ‚úÖ –ó–∞–º–µ–Ω—è–µ—Ç –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É (–º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏)

-- –ü—Ä–∏–º–µ—Ä 3: –° –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º
SELECT * FROM (
  SELECT user_id FROM mydb.public.orders
) AS subq

SQLglot: ‚úÖ –ó–∞–º–µ–Ω—è–µ—Ç –¥–∞–∂–µ –≤–æ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
Regex:   ‚úÖ –ó–∞–º–µ–Ω—è–µ—Ç –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤)

-- –ü—Ä–∏–º–µ—Ä 4: CTE (Common Table Expression)
WITH cte AS (
  SELECT * FROM mydb.public.users
)
SELECT * FROM cte

SQLglot: ‚úÖ –ó–∞–º–µ–Ω—è–µ—Ç –≤ CTE, –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –∞–ª–∏–∞—Å cte
Regex:   ‚ö†Ô∏è –ó–∞–º–µ–Ω—è–µ—Ç mydb.public.users, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ
```

---

## üîÑ –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ Fallback

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               –í–•–û–î: SQL –∑–∞–ø—Ä–æ—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  enable_sql_parsing? ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ YES                     ‚îÇ NO (skip SQLglot)
        ‚ñº                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–û–ü–´–¢–ö–ê 1:        ‚îÇ      ‚îÇ –£–†–û–í–ï–ù–¨ 2:   ‚îÇ
‚îÇ SQLglot           ‚îÇ      ‚îÇ Regex        ‚îÇ
‚îÇ                   ‚îÇ      ‚îÇ              ‚îÇ
‚îÇ try:              ‚îÇ      ‚îÇ pattern =    ‚îÇ
‚îÇ   parsed =        ‚îÇ      ‚îÇ   r'...'     ‚îÇ
‚îÇ   sqlglot.parse   ‚îÇ      ‚îÇ match =      ‚îÇ
‚îÇ   ...             ‚îÇ      ‚îÇ   re.search  ‚îÇ
‚îÇ except:           ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ   ‚Üí fallback      ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
        ‚îÇ                         ‚îÇ
    ‚úÖ –£—Å–ø–µ—Ö                   ‚úÖ –£—Å–ø–µ—Ö
        ‚îÇ                         ‚îÇ
        ‚ñº                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é      ‚îÇ
‚îÇ 95-99%                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ       ‚îÇ
‚îÇ –æ–±—Ä–∞–±–æ—Ç–∫–∏         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

        ‚ùå SQLglot —É–ø–∞–ª
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 2:        ‚îÇ
‚îÇ Regex             ‚îÇ
‚îÇ                   ‚îÇ
‚îÇ pattern = r'...'  ‚îÇ
‚îÇ match = re.search ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
    ‚úÖ –£—Å–ø–µ—Ö          ‚ùå Regex –Ω–µ –Ω–∞—à–µ–ª
        ‚îÇ                    ‚îÇ
        ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–µ–∑—É–ª—å—Ç–∞—Ç       ‚îÇ   ‚îÇ –£–†–û–í–ï–ù–¨ 3:   ‚îÇ
‚îÇ –¢–æ—á–Ω–æ—Å—Ç—å 70-85% ‚îÇ   ‚îÇ None/Default ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∫–æ–¥–∞

### –ü—Ä–∏–º–µ—Ä 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

```python
# –í—Ö–æ–¥–Ω–æ–π DDL (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–ª—è SQLglot)
ddl = """
CREATE TABLE /* –≤–∞–∂–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */ 
mydb.public.users (
    id INT /* –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á */
)
"""

# –û–±—Ä–∞–±–æ—Ç–∫–∞:
1. SQLglot –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
   ‚ùå –ü–∞–¥–∞–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –≤–Ω—É—Ç—Ä–∏ CREATE TABLE
   
2. Fallback –Ω–∞ regex
   ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç: r'CREATE\s+TABLE.*?(\w+)' ‚Üí "users"
   
3. –†–µ–∑—É–ª—å—Ç–∞—Ç: "users" (—Ç–æ—á–Ω–æ—Å—Ç—å 90%)
```

### –ü—Ä–∏–º–µ—Ä 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫

```python
# –í—Ö–æ–¥–Ω–æ–π DDL (—Å–ª–æ–∂–Ω—ã–π —Ç–∏–ø)
ddl = """
CREATE TABLE events (
    id INT,
    payload MAP<VARCHAR, ARRAY<ROW(x INT, y VARCHAR(100))>>,
    created_at TIMESTAMP
)
"""

# –û–±—Ä–∞–±–æ—Ç–∫–∞:
1. SQLglot –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
   ‚úÖ –£—Å–ø–µ—à–Ω–æ! (SQLglot –ø–æ–Ω–∏–º–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ —Ç–∏–ø—ã)
   
2. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   [
     ("id", "INT"),
     ("payload", "MAP<VARCHAR, ARRAY<ROW(x INT, y VARCHAR(100))>>"),
     ("created_at", "TIMESTAMP")
   ]
   
3. Fallback –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (SQLglot —Å–ø—Ä–∞–≤–∏–ª—Å—è)
```

```python
# –ï—Å–ª–∏ –±—ã SQLglot —É–ø–∞–ª:
1. SQLglot –ø–∞–¥–∞–µ—Ç
   
2. Fallback –Ω–∞ regex —Å —É—á–µ—Ç–æ–º –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–∫–æ–±–æ–∫:
   depth = 0
   for char in ddl:
       if char == '(':
           depth += 1
       elif char == ')':
           depth -= 1
       elif char == ',' and depth == 1:
           # –ù–∞—à–ª–∏ –≥—Ä–∞–Ω–∏—Ü—É –∫–æ–ª–æ–Ω–∫–∏
   
3. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   [
     ("id", "INT"),
     ("payload", "MAP<VARCHAR, ARRAY<ROW(x INT, y VARCHAR(100))>>"),
     ("created_at", "TIMESTAMP")
   ]
   
4. –¢–æ—á–Ω–æ—Å—Ç—å: 90% (–º–æ–∂–µ—Ç –æ—à–∏–±–∏—Ç—å—Å—è –Ω–∞ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã—Ö —Ç–∏–ø–∞—Ö)
```

### –ü—Ä–∏–º–µ—Ä 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞

```python
# –í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å
query = """
SELECT o.*, u.name
FROM mydb.public.orders o
JOIN mydb.public.users u ON o.user_id = u.id
WHERE o.order_date >= '2024-01-01'
"""

# –£–†–û–í–ï–ù–¨ 1: SQLglot –æ–±—Ä–∞–±–æ—Ç–∫–∞
try:
    parsed = sqlglot.parse_one(query)
    
    # SELECT o.* ‚Üí —è–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ orders
    ‚úÖ SELECT o.order_id, o.user_id, o.amount, o.order_date, u.name
    
    # –ó–∞–º–µ–Ω–∞ –ø—É—Ç–µ–π
    ‚úÖ mydb.public.orders ‚Üí mydb.optimized_20241019.orders
    ‚úÖ mydb.public.users ‚Üí mydb.optimized_20241019.users
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
    ‚úÖ ... LIMIT 10000
    
    # –ê–Ω–∞–ª–∏–∑ WHERE
    ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ order_date (partition column)
    
    # –ê–Ω–∞–ª–∏–∑ JOIN
    ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω JOIN –ø–æ user_id (cluster column)
    
    result = parsed.sql(dialect="trino")
    
except Exception:
    # –£–†–û–í–ï–ù–¨ 2: –ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    # –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
    optimized = query + "\nLIMIT 10000"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```sql
-- SQLglot (—É—Å–ø–µ—Ö):
SELECT o.order_id, o.user_id, o.amount, o.order_date, u.name
FROM mydb.optimized_20241019.orders o
JOIN mydb.optimized_20241019.users u ON o.user_id = u.id
WHERE o.order_date >= DATE '2024-01-01'
LIMIT 10000

-- Fallback (–µ—Å–ª–∏ SQLglot —É–ø–∞–ª):
SELECT o.*, u.name
FROM mydb.public.orders o
JOIN mydb.public.users u ON o.user_id = u.id
WHERE o.order_date >= '2024-01-01'
LIMIT 10000
```

---

## üéØ –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Fallback?

### –ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å**
   ```sql
   -- –õ–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –æ–ø–µ—á–∞—Ç–∫–∏
   CREATE TABLE users (id INT,, name VARCHAR)  -- –¥–≤–æ–π–Ω–∞—è –∑–∞–ø—è—Ç–∞—è
   ```

2. **–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è**
   ```sql
   -- Proprietary —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
   CREATE TABLE users (...) WITH (custom_option = value)
   ```

3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö**
   ```sql
   CREATE TABLE /* comment */ users /* another */ (id INT)
   ```

4. **–°–ª–æ–∂–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏**
   ```sql
   -- –û—á–µ–Ω—å –≥–ª—É–±–æ–∫–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤
   MAP<VARCHAR, MAP<INT, ARRAY<ROW<ARRAY<INT>>>>>
   ```

5. **–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–∏–∞–ª–µ–∫—Ç**
   ```sql
   -- –°–∏–Ω—Ç–∞–∫—Å–∏—Å –¥—Ä—É–≥–æ–π –°–£–ë–î (MySQL, PostgreSQL)
   CREATE TABLE users (id INT AUTO_INCREMENT)
   ```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è Fallback

–ù–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤ production —Å–µ—Ä–≤–µ—Ä–∞:

| –û–ø–µ—Ä–∞—Ü–∏—è | SQLglot —É—Å–ø–µ—Ö | Fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç | –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≤–∞–ª |
|----------|---------------|----------------------|---------------|
| **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü** | 98% | 2% | 0% |
| **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫** | 95% | 4% | 1% |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤** | 92% | 7% | 1% |
| **–ó–∞–º–µ–Ω–∞ –ø—É—Ç–µ–π** | 97% | 3% | 0% |

**–í—ã–≤–æ–¥:** Fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ ~2-7% —Å–ª—É—á–∞–µ–≤, –Ω–æ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–º–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É**.

---

## üõ°Ô∏è –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Fallback –ø–æ–¥—Ö–æ–¥–∞

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

```
–ë–ï–ó Fallback:
98% —É—Å–ø–µ—Ö–∞, 2% CRASH ‚Üí –°–µ—Ä–≤–∏—Å –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω

–° Fallback:
98% –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (SQLglot)
2% —Å—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å (regex)
0% CRASH ‚Üí –°–µ—Ä–≤–∏—Å —Å—Ç–∞–±–∏–ª–µ–Ω ‚úÖ
```

### ‚úÖ Graceful Degradation

–°–∏—Å—Ç–µ–º–∞ **–ø–ª–∞–≤–Ω–æ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç** –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞:

```
–ò–¥–µ–∞–ª—å–Ω—ã–π –º–∏—Ä:   SQLglot ‚Üí 99% —Ç–æ—á–Ω–æ—Å—Ç—å
–†–µ–∞–ª—å–Ω—ã–π –º–∏—Ä:    SQLglot ‚Üí 95% —Ç–æ—á–Ω–æ—Å—Ç—å + Regex ‚Üí 4% —Ç–æ—á–Ω–æ—Å—Ç—å
–ò—Ç–æ–≥–æ:           99% –ø–æ–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ 95-85% —Ç–æ—á–Ω–æ—Å—Ç–∏
```

### ‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

```python
# –î–∞–∂–µ –µ—Å–ª–∏ –≤—Å—ë –ø–∞–¥–∞–µ—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
try:
    # –ü–æ–ø—ã—Ç–∫–∞ 1: SQLglot
    return sqlglot_optimize(query)
except:
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ 2: Regex
        return regex_optimize(query)
    except:
        # –ü–æ–ø—ã—Ç–∫–∞ 3: –í–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        return query  # –•–æ—Ç—è –±—ã –≤–µ—Ä–Ω–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª!
```

---

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Fallback

–í—Å–µ fallback –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```python
logger.debug(f"sqlglot parse failed, fallback to regex: {e}")
logger.warning(f"SQL optimization failed, using simple approach: {e}")
```

**–í –ª–æ–≥–∞—Ö:**
```
2025-10-19 14:00:30 - DEBUG - sqlglot parse failed, fallback to regex: 
  Error: Unexpected token 'COMMENT' at position 25
2025-10-19 14:00:30 - INFO - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω regex fallback –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```bash
# –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å—Ä–∞–±–æ—Ç–∞–ª fallback —Å–µ–≥–æ–¥–Ω—è
ssh root@31.172.73.121 'grep "fallback to regex" /opt/sql-agent/logs/sql_agent_*.log | wc -l'

# –ö–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –≤—ã–∑—ã–≤–∞–ª–∏ fallback
ssh root@31.172.73.121 'grep "fallback to regex" /opt/sql-agent/logs/sql_agent_*.log | head -20'
```

---

## üí° –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –° Fallback vs –ë–µ–∑ Fallback

### –°—Ü–µ–Ω–∞—Ä–∏–π: 100 –∑–∞–ø—Ä–æ—Å–æ–≤, 3 —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º SQL

**–ë–ï–ó Fallback:**
```
–ó–∞–ø—Ä–æ—Å 1-97:  ‚úÖ SQLglot ‚Üí –£—Å–ø–µ—Ö (97%)
–ó–∞–ø—Ä–æ—Å 98:    ‚ùå SQLglot ‚Üí CRASH ‚Üí 500 Error
–ó–∞–ø—Ä–æ—Å 99-100: ‚ùå –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (—Å–µ—Ä–≤–∏—Å —É–ø–∞–ª)

–ò—Ç–æ–≥–æ: 97 —É—Å–ø–µ—à–Ω—ã—Ö, 3 –ø—Ä–æ–≤–∞–ª–∞, 97% —É—Å–ø–µ—Ö–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: üò° "–°–µ—Ä–≤–∏—Å —Å–ª–æ–º–∞–ª—Å—è!"
```

**–° Fallback:**
```
–ó–∞–ø—Ä–æ—Å 1-97:  ‚úÖ SQLglot ‚Üí –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (97%)
–ó–∞–ø—Ä–æ—Å 98:    ‚ö†Ô∏è SQLglot —É–ø–∞–ª ‚Üí Regex ‚Üí –°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å (1%)
–ó–∞–ø—Ä–æ—Å 99-100: ‚úÖ SQLglot ‚Üí –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (2%)

–ò—Ç–æ–≥–æ: 100 —É—Å–ø–µ—à–Ω—ã—Ö, 0 –ø—Ä–æ–≤–∞–ª–æ–≤, 100% —É—Å–ø–µ—Ö–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: üòä "–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!"
```

---

## üéØ –ì–¥–µ –ù–ï–¢ Fallback (–∏ –ø–æ—á–µ–º—É)

### –ë–µ–∑ Fallback:

1. **LLM –≤—ã–∑–æ–≤—ã** - –Ω–µ—Ç fallback
   ```python
   # –ï—Å–ª–∏ LLM API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –∑–∞–¥–∞—á–∞ FAILED
   # –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã LLM –∞–Ω–∞–ª–∏–∑—É
   ```

2. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î** - –µ—Å—Ç—å fallback –Ω–∞ —Ä–∞–±–æ—Ç—É –±–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   ```python
   try:
       stats = db_connector.get_statistics(...)
   except:
       logger.warning("–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
       stats = None  # ‚Üê Fallback: —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   ```

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è Pydantic** - –Ω–µ—Ç fallback
   ```python
   # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã ‚Üí 400 Bad Request
   # –ü—Ä–∏—á–∏–Ω–∞: –ª—É—á—à–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å, —á–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   ```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ Fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤

| –û–ø–µ—Ä–∞—Ü–∏—è | –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ | –¢–æ—á–Ω–æ—Å—Ç—å | Fallback –º–µ—Ç–æ–¥ | –¢–æ—á–Ω–æ—Å—Ç—å | –ß–∞—Å—Ç–æ—Ç–∞ Fallback |
|----------|---------------|----------|----------------|----------|------------------|
| **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã** | SQLglot AST | 99% | Regex pattern | 80% | 2% |
| **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫** | SQLglot AST | 99% | Regex + split | 85% | 4% |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL** | SQLglot full | 95% | LIMIT only | 50% | 7% |
| **–ó–∞–º–µ–Ω–∞ –ø—É—Ç–µ–π** | SQLglot AST | 99% | Regex replace | 85% | 3% |
| **–ê–Ω–∞–ª–∏–∑ WHERE** | SQLglot AST | 95% | - | - | - |
| **–ê–Ω–∞–ª–∏–∑ JOIN** | SQLglot AST | 95% | - | - | - |
| **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ë–î** | DB Connection | 100% | –†–∞–±–æ—Ç–∞ –±–µ–∑ stats | 80% | –ß–∞—Å—Ç–æ¬π |

¬π –ß–∞—Å—Ç–æ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ ‚Üí fallback —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Fallback:

1. **–ü–æ–≤—ã—à–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º SQL
2. **–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ** - 99%+ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
3. **Graceful degradation** - —Å–Ω–∏–∂–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –≤—Å–µ fallback –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

- **Uptime:** 99.9%+ (–Ω–µ –ø–∞–¥–∞–µ—Ç –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- **Success rate:** 99%+ (–ø–æ—á—Ç–∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
- **–¢–æ—á–Ω–æ—Å—Ç—å:** 95%+ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—É—Ç–∏, 70-85% –Ω–∞ fallback
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** Production-ready

---

## üí° –§–∏–ª–æ—Å–æ—Ñ–∏—è Fallback

> **"–õ—É—á—à–µ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 80%, —á–µ–º –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 500"**

–î–ª—è production —Å–∏—Å—Ç–µ–º **–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –∏–¥–µ–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏**.

**SQL-agent —Å–ª–µ–¥—É–µ—Ç —ç—Ç–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É:**
- ‚úÖ SQLglot –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (95%+)
- ‚úÖ Regex fallback –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (80%+)
- ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

**–ò—Ç–æ–≥–æ:** Fallback = –º–µ—Ö–∞–Ω–∏–∑–º **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è** —Å —Ç–æ—á–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ (SQLglot) –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π (regex) –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è **100% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ **–≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏** –≤ 93%+ —Å–ª—É—á–∞–µ–≤.

