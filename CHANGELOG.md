# Changelog - SQL Agent Improvements

## –í–µ—Ä—Å–∏—è 1.1.0 (2025-10-18)

### üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: –û–±—Ä–∞–±–æ—Ç–∫–∞ SQL-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** Sqlglot –ø–∞–¥–∞–ª –Ω–∞ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ `--` –∏ `/* */`

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_clean_sql_for_parsing()` –≤ `sql_agent/llm_analyzer.py`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö (`--`) –∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö (`/* */`) –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- SQL –æ—á–∏—â–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º –≤ sqlglot

**–§–∞–π–ª—ã:**
- `sql_agent/llm_analyzer.py` - —Å—Ç—Ä–æ–∫–∏ 727-740, 757-759

**–≠—Ñ—Ñ–µ–∫—Ç:** 
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ —Ç–∏–ø–∞ `Expecting ). Line 1, Col: 230`
- ‚úÖ –ë–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
- ‚úÖ –ú–µ–Ω—å—à–µ fallback –Ω–∞ simple_optimizations

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3: –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–æ–≥–∏ –∑–∞–¥–∞—á –≤–º–µ—Å—Ç–æ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ª—É—á–∞—è –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ (–ø–æ –ø–æ–ª—è–º `task_id`, `timestamp`, `input`, `output`)
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç—Ä–µ–±—É–µ–º—ã–º –ø–æ–ª—è–º
- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –æ—Ç–≤–µ—Ç–µ

**–§–∞–π–ª—ã:**
- `sql_agent/api.py` - —Å—Ç—Ä–æ–∫–∏ 47-91

**–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤:**

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–æ–≥–∞:
```json
{
  "error": "Bad Request",
  "detail": "–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ñ–∞–π–ª –ª–æ–≥–∞ –∑–∞–¥–∞—á–∏ –≤–º–µ—Å—Ç–æ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞",
  "hint": "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ JSON —Å –ø–æ–ª—è–º–∏: url, ddl, queries",
  "example": {
    "url": "jdbc:trino://host:port?user=username",
    "ddl": [{"statement": "CREATE TABLE ..."}],
    "queries": [{"queryid": "1", "query": "SELECT ...", "runquantity": 100}]
  }
}
```

–ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
```json
{
  "error": "Bad Request",
  "detail": "–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö",
  "required_fields": {
    "url": "JDBC connection string (must start with 'jdbc:')",
    "ddl": "Array of DDL statements with 'statement' field",
    "queries": "Array of queries with 'queryid', 'query', 'runquantity' fields"
  },
  "validation_errors": [...]
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ú–µ–Ω—å—à–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #4: Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è LLM

**–ü—Ä–æ–±–ª–µ–º–∞:** LLM –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—Ö–µ–º (45+ —Ç–∞–±–ª–∏—Ü)

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Å **2 –¥–æ 3**
- –£–ª—É—á—à–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ JSON –æ—Ç markdown –±–ª–æ–∫–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ trailing commas
- –£–º–Ω—ã–µ repair –ø—Ä–æ–º–ø—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ (JSON syntax vs schema validation)

**–§–∞–π–ª—ã:**
- `sql_agent/llm_analyzer.py` - —Å—Ç—Ä–æ–∫–∏ 933-989 (–º–µ—Ç–æ–¥ `_call_with_retries`)
- `sql_agent/llm_analyzer.py` - —Å—Ç—Ä–æ–∫–∏ 1037-1078 (–º–µ—Ç–æ–¥ `_extract_json_from_response`)
- `sql_agent/llm_analyzer.py` - —Å—Ç—Ä–æ–∫–∏ 1155-1213 (–º–µ—Ç–æ–¥ `_build_repair_prompt`)

**–£–ª—É—á—à–µ–Ω–∏—è:**

1. **–û—á–∏—Å—Ç–∫–∞ JSON:**
   - –£–¥–∞–ª–µ–Ω–∏–µ ````json` –∏ ````javascript` –±–ª–æ–∫–æ–≤
   - –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ JSON
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ trailing commas

2. **–£–º–Ω—ã–µ repair –ø—Ä–æ–º–ø—Ç—ã:**
   - –î–ª—è JSON –æ—à–∏–±–æ–∫: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É
   - –î–ª—è schema –æ—à–∏–±–æ–∫: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–ª—è–º
   - –ü–æ–∫–∞–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—à–∏–±–æ—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å
- ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–¥–∞—á —Å –æ—à–∏–±–∫–æ–π "–ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –≤–∞–ª–∏–¥–Ω—ã–π JSON"
- ‚úÖ –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ LLM

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #5: –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–±–æ—Ç–µ —Å–∏—Å—Ç–µ–º—ã –∏ –æ—à–∏–±–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π endpoint `GET /metrics`
- –°—á–µ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º –≤ TaskManager
- Tracking uptime —Å–µ—Ä–≤–∏—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ health status

**–§–∞–π–ª—ã:**
- `sql_agent/task_manager.py` - —Å—Ç—Ä–æ–∫–∏ 41-48 (—Å—á–µ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫)
- `sql_agent/task_manager.py` - —Å—Ç—Ä–æ–∫–∏ 89-102 (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π get_stats)
- `sql_agent/task_manager.py` - —Å—Ç—Ä–æ–∫–∏ 143-165 (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã —Å—á–µ—Ç—á–∏–∫–æ–≤)
- `sql_agent/api.py` - —Å—Ç—Ä–æ–∫–∏ 47, 240-293 (endpoint /metrics)

**–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

```json
{
  "service": "sql-agent",
  "version": "1.0.0",
  "uptime": {
    "seconds": 3600,
    "minutes": 60,
    "hours": 1
  },
  "health": "healthy",
  "tasks": {
    "total": 50,
    "running": 2,
    "completed": 45,
    "failed": 3,
    "max_workers": 4,
    "error_rate": 6.0
  },
  "errors": {
    "timeout_errors": 1,
    "llm_errors": 1,
    "validation_errors": 0,
    "database_errors": 1,
    "total_errors": 3
  },
  "llm": {
    "enabled": true,
    "available": true
  }
}
```

**Health Status:**
- `healthy` - error rate < 20%
- `warning` - –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ë–î (>10)
- `degraded` - error rate 20-50%
- `critical` - error rate > 50%

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –õ–µ–≥–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ò–∑–º–µ–Ω–µ–Ω–æ |
|-----------|----------|
| –§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ | 3 |
| –°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ | ~200 |
| –ù–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤ | 4 |
| –ù–æ–≤—ã—Ö endpoints | 1 (`/metrics`) |
| –£–ª—É—á—à–µ–Ω–∏–π retry | 2‚Üí3 –ø–æ–ø—ã—Ç–∫–∏ |

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl http://localhost:8001/metrics

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl http://localhost:8001/stats
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–¢–µ–ø–µ—Ä—å –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```python
import requests

response = requests.post("http://localhost:8001/new", json=invalid_data)
if response.status_code == 400:
    error = response.json()
    print(error["detail"])      # –ü–æ–Ω—è—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    print(error.get("hint"))    # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
    print(error.get("example")) # –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
```

### 3. SQL —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å SQL —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –±–µ–∑ –æ—à–∏–±–æ–∫:

```sql
-- –≠—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
SELECT * FROM table
WHERE date > '2023-01-01'  -- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
/* –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π
   –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):

1. **Structured logging** - JSON —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
2. **Database connection pooling** - –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è 401 –æ—à–∏–±–æ–∫
3. **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
4. **Webhook notifications** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã**:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è (–∫—Ä–æ–º–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ `quality_score`)
- –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ `/stats` –¥–æ–±–∞–≤–ª–µ–Ω—ã, —Å—Ç–∞—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –ù–æ–≤—ã–π endpoint `/metrics` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

