# üìä –°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π SQL Agent

## ‚úÖ –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏:**

```python
task_manager = SimpleTaskManager(
    max_workers=10,             # –ú–∞–∫—Å–∏–º—É–º 10 –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    max_queue_size=100,         # –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏
    cleanup_after_hours=24      # –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
)
```

---

## üìà **–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏?**

### **–û–¢–í–ï–¢: –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–¥–∞—á** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| **max_queue_size** | **100** | –ú–∞–∫—Å–∏–º—É–º –∑–∞–¥–∞—á –≤ –ø–∞–º—è—Ç–∏ |
| **max_workers** | **10** | –†–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ |
| **–í –æ–∂–∏–¥–∞–Ω–∏–∏** | **–¥–æ 90** | –û—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ (100 - 10 = 90) |

---

## üîÑ **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å:**

### **–ü—Ä–∏–º–µ—Ä —Å 10 –∑–∞–¥–∞—á–∞–º–∏:**

```
–í—Ä–µ–º—è ‚Üí

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û–ß–ï–†–ï–î–¨ (max 100 –∑–∞–¥–∞—á)                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚úÖ Task #1 [DONE]      ‚Üê –ó–∞–≤–µ—Ä—à–µ–Ω–∞                  ‚îÇ
‚îÇ  ‚úÖ Task #2 [DONE]      ‚Üê –ó–∞–≤–µ—Ä—à–µ–Ω–∞                  ‚îÇ
‚îÇ  üîÑ Task #3 [RUNNING]   ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (slot 1/10)    ‚îÇ
‚îÇ  üîÑ Task #4 [RUNNING]   ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (slot 2/10)    ‚îÇ
‚îÇ  ...                                                  ‚îÇ
‚îÇ  üîÑ Task #10 [RUNNING]  ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (slot 8/10)    ‚îÇ
‚îÇ  üîÑ Task #11 [RUNNING]  ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (slot 9/10)    ‚îÇ
‚îÇ  üîÑ Task #12 [RUNNING]  ‚Üê –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (slot 10/10)   ‚îÇ
‚îÇ  ‚è≥ Task #13 [RUNNING]  ‚Üê –ñ–¥–µ—Ç —Å–µ–º–∞—Ñ–æ—Ä (–≤ –æ—á–µ—Ä–µ–¥–∏)   ‚îÇ
‚îÇ  ‚è≥ Task #14 [RUNNING]  ‚Üê –ñ–¥–µ—Ç —Å–µ–º–∞—Ñ–æ—Ä (–≤ –æ—á–µ—Ä–µ–¥–∏)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–°—Ç–∞—Ç—É—Å –≤ /metrics:
{
  "tasks": {
    "total": 14,
    "running": 12,              ‚Üê –í—Å–µ —Å —Å—Ç–∞—Ç—É—Å–æ–º RUNNING
    "actually_processing": 10,  ‚Üê –†–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
    "queued": 2,                ‚Üê –ñ–¥—É—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–ª–æ—Ç–∞
    "completed": 2,
    "failed": 0
  },
  "queue": {
    "max_size": 100,
    "current_size": 10,
    "usage_percent": 10.0,
    "available_slots": 90       ‚Üê –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ 90 –∑–∞–¥–∞—á
  }
}
```

---

## üö´ **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏?**

### **–°—Ü–µ–Ω–∞—Ä–∏–π: –û—Ç–ø—Ä–∞–≤–∫–∞ 101-–π –∑–∞–¥–∞—á–∏ –ø—Ä–∏ max_queue_size=100**

```bash
curl -X POST http://localhost:8001/new -d @data.json
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "detail": "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞. –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–¥–∞—á, —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–¥–∞—á –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ max_queue_size."
}
```

**HTTP —Å—Ç–∞—Ç—É—Å:** `500 Internal Server Error`

**–°—á–µ—Ç—á–∏–∫:** `queue_full_errors` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

---

## üßπ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. **–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞
2. **–ö–∞–∂–¥—ã–π —á–∞—Å** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
3. **–£–¥–∞–ª—è–µ—Ç** –∑–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `DONE` –∏–ª–∏ `FAILED`
4. **–õ–æ–≥–∏—Ä—É–µ—Ç** –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

```
2025-10-18 15:00:00 - task_manager - INFO - üßπ –û—á–∏—â–µ–Ω–æ 45 –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (—Å—Ç–∞—Ä—à–µ 24—á)
```

### **–†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:**

–ú–µ—Ç–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ API (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å endpoint):

```python
# –í–Ω—É—Ç—Ä–∏ –∫–æ–¥–∞:
task_manager.cleanup_old_tasks(hours=1)  # –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á–∏ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞
```

---

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏:**

### **1. Endpoint `/metrics`**

```bash
curl http://localhost:8001/metrics
```

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
```json
{
  "tasks": {
    "actually_processing": 4,  // –†–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–µ–π—á–∞—Å
    "queued": 6,               // –ñ–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏
    "running": 10              // –í—Å–µ —Å —Å—Ç–∞—Ç—É—Å–æ–º RUNNING (processing + queued)
  },
  "queue": {
    "max_size": 100,
    "current_size": 50,
    "usage_percent": 50.0,
    "available_slots": 50
  },
  "errors": {
    "queue_full_errors": 3     // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ—á–µ—Ä–µ–¥—å –±—ã–ª–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞
  }
}
```

### **2. Endpoint `/stats`**

–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —Ç–æ–π –∂–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π + –ª–æ–≥–∏.

---

## ‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π:**

### **–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á:**

–í `sql_agent/api.py`:
```python
task_manager = SimpleTaskManager(
    max_workers=10,         # –í–º–µ—Å—Ç–æ 4
    max_queue_size=200,     # –í–º–µ—Å—Ç–æ 100
)
```

### **–û—Ç–∫–ª—é—á–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏:**

```python
task_manager = SimpleTaskManager(
    max_workers=10,
    max_queue_size=0,       # 0 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
)
```

‚ö†Ô∏è **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø:** –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—é –ø–∞–º—è—Ç–∏!

### **–£—Å–∫–æ—Ä–∏—Ç—å –æ—á–∏—Å—Ç–∫—É:**

```python
task_manager = SimpleTaskManager(
    max_workers=10,
    cleanup_after_hours=1,  # –û—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å (–≤–º–µ—Å—Ç–æ 24)
)
```

---

## üéØ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ:**

| –°—Ü–µ–Ω–∞—Ä–∏–π | max_workers | max_queue_size | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------------|----------------|----------|
| **–õ–µ–≥–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** | 2-4 | 50 | –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è |
| **–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞** | 4-8 | 100 | –î–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ |
| **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** ‚úÖ | 10-15 | 200 | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (—Ç–µ–∫—É—â–∞—è) |
| **–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** ‚ö†Ô∏è | 20-30 | 500 | –¢—Ä–µ–±—É–µ—Ç –º–æ—â–Ω—ã–π —Å–µ—Ä–≤–µ—Ä |
| **–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π** ‚ùå | 30 | 0 | –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (—Ä–∏—Å–∫ DoS) |

---

## üìâ **–ö–∞–∫ –æ—á–µ—Ä–µ–¥—å –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è):**
- ‚ùå 100 –∑–∞–¥–∞—á ‚Üí 100 –∑–∞–¥–∞—á –∑–∞–ø—É—â–µ–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- ‚ùå –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ CPU, –ø–∞–º—è—Ç–∏, LLM API
- ‚ùå –ó–∞–¥–∞—á–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è):**
- ‚úÖ 100 –∑–∞–¥–∞—á ‚Üí 10 –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, 90 –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã
- ‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ 24—á
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏

---

## üîç **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏:**

```python
import requests

metrics = requests.get("http://localhost:8001/metrics").json()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É
usage = metrics["queue"]["usage_percent"]

if usage > 90:
    print("‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—á–µ—Ä–µ–¥—å –ø–æ—á—Ç–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞!")
elif usage > 70:
    print("‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–∏")
elif usage > 50:
    print("‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞")
else:
    print("‚úÖ –ù–∏–∑–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
processing = metrics["tasks"]["actually_processing"]
queued = metrics["tasks"]["queued"]

print(f"–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: {processing}, –í –æ—á–µ—Ä–µ–¥–∏: {queued}")
```

---

## üí° **–ò—Ç–æ–≥–æ:**

### **–í–æ–ø—Ä–æ—Å:** –°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏?

### **–û—Ç–≤–µ—Ç:**

‚úÖ **–ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–¥–∞—á** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `max_queue_size`)

–ò–∑ –Ω–∏—Ö:
- **10 –∑–∞–¥–∞—á** –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ (—á–µ—Ä–µ–∑ —Å–µ–º–∞—Ñ–æ—Ä)
- **–¥–æ 90 –∑–∞–¥–∞—á** –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏
- **–°—Ç–∞—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ** –∑–∞–¥–∞—á–∏ –æ—á–∏—â–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–∏—Ç—å 101-—é –∑–∞–¥–∞—á—É —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É!

---

**–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ!** üéõÔ∏è

