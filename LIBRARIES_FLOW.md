# üìö –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ SQL-agent

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ:
- **Pydantic** - 1 –∏–º–ø–æ—Ä—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö API endpoints
- **SQLglot** - 28 –≤—ã–∑–æ–≤–æ–≤ –≤ –∫–æ–¥–µ

### ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–µ—Å—Ç—å –≤ requirements.txt, –Ω–æ –Ω–µ –≤ –∫–æ–¥–µ):
- **sqlparse** - 0 –≤—ã–∑–æ–≤–æ–≤
- **jsonschema** - 0 –≤—ã–∑–æ–≤–æ–≤

---

## üìä –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–û–¢–û–ö –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–ü–†–û–°–ê                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1Ô∏è‚É£  HTTP Request (JSON)
    ‚îÇ
    ‚îú‚îÄ> FastAPI –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
    ‚îÇ
    ‚ñº
2Ô∏è‚É£  PYDANTIC (–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
    ‚îÇ
    ‚îú‚îÄ> OptimizationRequest.validate()
    ‚îú‚îÄ> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (url: str, ddl: List[Dict], queries: List[Dict])
    ‚îú‚îÄ> –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ (url.startswith('jdbc:'))
    ‚îú‚îÄ> –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (queryid, query, runquantity)
    ‚îÇ
    ‚ñº
3Ô∏è‚É£  Task Manager (–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)
    ‚îÇ
    ‚îú‚îÄ> –°–æ–∑–¥–∞–Ω–∏–µ Task –æ–±—ä–µ–∫—Ç–∞ (Pydantic)
    ‚îú‚îÄ> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
    ‚îú‚îÄ> –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    ‚îÇ
    ‚ñº
4Ô∏è‚É£  LLM Analyzer (–û–±—Ä–∞–±–æ—Ç–∫–∞)
    ‚îÇ
    ‚îú‚îÄ> –ü–∞—Ä—Å–∏–Ω–≥ DDL
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: parse_one(ddl) ‚Üí AST
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: find(exp.Table) ‚Üí –∏–º—è —Ç–∞–±–ª–∏—Ü—ã
    ‚îÇ   ‚îî‚îÄ> SQLGLOT: find_all(exp.ColumnDef) ‚Üí –∫–æ–ª–æ–Ω–∫–∏
    ‚îÇ
    ‚îú‚îÄ> LLM –∞–Ω–∞–ª–∏–∑ (OpenAI/OpenRouter)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    ‚îÇ
    ‚îú‚îÄ> –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: parse_one(query) ‚Üí AST
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: find_all(exp.Select) ‚Üí SELECT –±–ª–æ–∫–∏
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: SELECT * ‚Üí —è–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: find_all(exp.Table) ‚Üí –∑–∞–º–µ–Ω–∞ –ø—É—Ç–µ–π
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: find(exp.Where) ‚Üí –∞–Ω–∞–ª–∏–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π
    ‚îÇ   ‚îú‚îÄ> SQLGLOT: find_all(exp.Join) ‚Üí –∞–Ω–∞–ª–∏–∑ JOIN
    ‚îÇ   ‚îî‚îÄ> SQLGLOT: sql() ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
    ‚îÇ
    ‚îî‚îÄ> –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        ‚îÇ
        ‚îî‚îÄ> PYDANTIC: OptimizationResult.validate()
    
    ‚ñº
5Ô∏è‚É£  –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    ‚îÇ
    ‚îî‚îÄ> PYDANTIC: TaskResultResponse.validate()
        ‚îÇ
        ‚îî‚îÄ> FastAPI ‚Üí HTTP Response (JSON)
```

---

## 1Ô∏è‚É£ Pydantic - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

**–§–∞–π–ª:** `sql_agent/models.py`

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏:

```python
class OptimizationRequest(BaseModel):
    """–í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å"""
    url: str                      # JDBC URL
    ddl: List[Dict[str, str]]     # DDL —Ç–∞–±–ª–∏—Ü
    queries: List[Dict[str, Any]] # SQL –∑–∞–ø—Ä–æ—Å—ã

class OptimizationResult(BaseModel):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"""
    ddl: List[Dict[str, str]]        # –ù–æ–≤—ã–µ DDL
    migrations: List[Dict[str, str]] # –ú–∏–≥—Ä–∞—Ü–∏–∏
    queries: List[Dict[str, Any]]    # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

class Task(BaseModel):
    """–ó–∞–¥–∞—á–∞"""
    task_id: str
    status: TaskStatus
    request: OptimizationRequest
    result: Optional[OptimizationResult]
```

### –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã:

```python
@validator('url')
def validate_url(cls, v):
    if not v.startswith('jdbc:'):
        raise ValueError('URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å jdbc:')
    return v

@validator('queries')
def validate_queries(cls, v):
    for item in v:
        required = ['queryid', 'query', 'runquantity']
        for field in required:
            if field not in item:
                raise ValueError(f'–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç {field}')
    return v
```

### –ú–æ–º–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

```
POST /new ‚Üí FastAPI ‚Üí Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí Task Manager
                        ‚Üë
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 400 Bad Request –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã

---

## 2Ô∏è‚É£ SQLglot - –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è SQL

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

**–§–∞–π–ª:** `sql_agent/llm_analyzer.py`  
**–í—ã–∑–æ–≤–æ–≤:** 28 –≤ –∫–æ–¥–µ

### 8 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:

1. **_extract_table_name_robust()** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω —Ç–∞–±–ª–∏—Ü
2. **_extract_columns_robust()** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ DDL
3. **_replace_select_star_sqlglot()** - SELECT * ‚Üí —è–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
4. **_add_limit_sqlglot()** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
5. **_is_aggregation_sqlglot()** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–π
6. **_check_partition_usage()** - –∞–Ω–∞–ª–∏–∑ WHERE –¥–ª—è –ø–∞—Ä—Ç–∏—Ü–∏–π
7. **_check_cluster_joins()** - –∞–Ω–∞–ª–∏–∑ JOIN
8. **_replace_table_paths()** - –∑–∞–º–µ–Ω–∞ catalog.schema.table

### –ú–æ–º–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

```
–≠—Ç–∞–ø 2: –ü–∞—Ä—Å–∏–Ω–≥ DDL ‚Üí SQLglot
–≠—Ç–∞–ø 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí SQLglot (–æ—Å–Ω–æ–≤–Ω–æ–π —ç—Ç–∞–ø!)
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
# 1. –ü–∞—Ä—Å–∏–Ω–≥
parsed = sqlglot.parse_one(query, dialect="trino")

# 2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è
for select in parsed.find_all(sqlglot.exp.Select):
    # ... –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏

# 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
optimized = parsed.sql(dialect="trino")
```

---

## 3Ô∏è‚É£ sqlparse - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### –°—Ç–∞—Ç—É—Å: ‚ùå –ï—Å—Ç—å –≤ requirements.txt, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ

**–ü—Ä–∏—á–∏–Ω–∞:** SQLglot –º–æ—â–Ω–µ–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç AST-–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏.

**sqlparse —É–º–µ–µ—Ç:**
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SQL
- ‚úÖ –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è
- ‚ùå –ù–µ—Ç AST (—Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã)
- ‚ùå –ù–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- SQLglot –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –Ω—É–∂–¥—ã
- sqlparse –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ requirements.txt

---

## 4Ô∏è‚É£ jsonschema - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### –°—Ç–∞—Ç—É—Å: ‚ùå –ï—Å—Ç—å –≤ requirements.txt, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ

**–ü—Ä–∏—á–∏–Ω–∞:** Pydantic –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç jsonschema.

**jsonschema —É–º–µ–µ—Ç:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è JSON –ø–æ —Å—Ö–µ–º–µ
- ‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π
- ‚ùå –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å FastAPI

**Pydantic —É–º–µ–µ—Ç:**
- ‚úÖ –í—Å—ë —á—Ç–æ jsonschema +
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è OpenAPI —Å—Ö–µ–º
- ‚úÖ –ù–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è Python

**–ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- Pydantic –º–æ—â–Ω–µ–µ –∏ —É–¥–æ–±–Ω–µ–µ
- FastAPI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Pydantic –Ω–∞—Ç–∏–≤–Ω–æ
- –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ requirements.txt

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å (POST /new)

```python
# –®–ê–ì 1: HTTP Request ‚Üí FastAPI
POST /new
{
  "url": "jdbc:trino://...",
  "ddl": [...],
  "queries": [...]
}

# –®–ê–ì 2: Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
request = OptimizationRequest(**json_data)
‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ ‚úÖ
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ ‚úÖ
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π ‚úÖ

# –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (Pydantic)
task = Task(request=request)
‚Üì
task_id –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
status = RUNNING
–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å

# –®–ê–ì 4: LLM Analyzer - –û–±—Ä–∞–±–æ—Ç–∫–∞

  # 4.1. –ü–∞—Ä—Å–∏–Ω–≥ DDL (SQLglot)
  for ddl in request.ddl:
      parsed = sqlglot.parse_one(ddl.statement)
      table_name = parsed.find(sqlglot.exp.Table).name
      columns = [col_def.this.name for col_def in parsed.find_all(sqlglot.exp.ColumnDef)]
  
  # 4.2. LLM –∞–Ω–∞–ª–∏–∑ (OpenAI API)
  llm_response = await client.chat.completions.create(...)
  ‚Üì
  JSON response —Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
  
  # 4.3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (SQLglot)
  for query in request.queries:
      parsed = sqlglot.parse_one(query.query)
      
      # SELECT * ‚Üí –∫–æ–ª–æ–Ω–∫–∏
      if SELECT *:
          select.expressions = [Column(col) for col in columns]
      
      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
      if not LIMIT:
          parsed = parsed.limit(10000)
      
      # –ó–∞–º–µ–Ω–∞ –ø—É—Ç–µ–π
      for table in find_all(exp.Table):
          table.set("db", new_schema)
      
      # –ê–Ω–∞–ª–∏–∑ WHERE (partition pruning)
      where_columns = find(exp.Where).find_all(exp.Column)
      
      # –ê–Ω–∞–ª–∏–∑ JOIN (cluster usage)
      join_columns = find_all(exp.Join).find_all(exp.Column)
      
      optimized = parsed.sql(dialect="trino")
  
  # 4.4. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (Pydantic)
  result = OptimizationResult(
      ddl=[...],
      migrations=[...],
      queries=[...]
  )

# –®–ê–ì 5: –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (Pydantic + FastAPI)
response = TaskResultResponse.from_optimization_result(result)
‚Üì
FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤ JSON
‚Üì
HTTP Response 200 OK
```

---

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –í requirements.txt | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –í—ã–∑–æ–≤–æ–≤ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|------------|-------------------|---------------------|------------|---------|-------------|
| **Pydantic** | ‚úÖ | ‚úÖ | –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö, –º–æ–¥–µ–ª–∏ | ~100+ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞ |
| **SQLglot** | ‚úÖ | ‚úÖ | –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è SQL | ~28 | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞ |
| **sqlparse** | ‚úÖ | ‚ùå | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SQL | 0 | üü¢ –ù–µ –Ω—É–∂–Ω–∞ |
| **jsonschema** | ‚úÖ | ‚ùå | –í–∞–ª–∏–¥–∞—Ü–∏—è JSON | 0 | üü¢ –ù–µ –Ω—É–∂–Ω–∞ |

---

## üéØ –ó–∞—á–µ–º –∫–∞–∂–¥–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞

### ‚úÖ Pydantic (–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)

**–†–æ–ª—å:** –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- ‚úÖ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è JSON

**–ú–æ–º–µ–Ω—Ç:** 
- –í—Ö–æ–¥: POST /new (–≤–∞–ª–∏–¥–∞—Ü–∏—è request body)
- –í—ã—Ö–æ–¥: GET /getresult (–≤–∞–ª–∏–¥–∞—Ü–∏—è response)

**–ö–æ–¥:**
```python
# models.py
class OptimizationRequest(BaseModel):
    url: str
    ddl: List[Dict[str, str]]
    queries: List[Dict[str, Any]]
    
    @validator('url')
    def validate_url(cls, v):
        if not v.startswith('jdbc:'):
            raise ValueError(...)
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π:** 7 (OptimizationRequest, OptimizationResult, Task, –∏ —Ç.–¥.)

---

### ‚úÖ SQLglot (–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)

**–†–æ–ª—å:** –ü–∞—Ä—Å–∏–Ω–≥, –∞–Ω–∞–ª–∏–∑ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ DDL (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–ª–æ–Ω–æ–∫)
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (AST –∞–Ω–∞–ª–∏–∑)
- ‚úÖ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (SELECT *, LIMIT, –ø—É—Ç–∏)
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π (WHERE, JOIN)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –æ–±—Ä–∞—Ç–Ω–æ

**–ú–æ–º–µ–Ω—Ç:**
- –≠—Ç–∞–ø 2: –ü–∞—Ä—Å–∏–Ω–≥ DDL
- –≠—Ç–∞–ø 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)

**–ö–æ–¥:**
```python
# llm_analyzer.py
parsed = sqlglot.parse_one(query, dialect="trino")

# –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è AST
for select in parsed.find_all(sqlglot.exp.Select):
    select.expressions = [...]

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
optimized = parsed.sql(dialect="trino")
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π:** 8 –æ—Å–Ω–æ–≤–Ω—ã—Ö, ~28 –≤—ã–∑–æ–≤–æ–≤ –Ω–∞ –∑–∞–¥–∞—á—É

---

### ‚ùå sqlparse (–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)

**–°—Ç–∞—Ç—É—Å:** –í requirements.txt, –Ω–æ 0 –≤—ã–∑–æ–≤–æ–≤ –≤ –∫–æ–¥–µ

**–ü–æ—á–µ–º—É –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- SQLglot –º–æ—â–Ω–µ–µ (AST vs —Ç–æ–∫–µ–Ω—ã)
- SQLglot –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é
- sqlparse —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ú–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å:** ‚úÖ –î–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ requirements.txt

**–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É (–ª–∏—à–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)

---

### ‚ùå jsonschema (–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)

**–°—Ç–∞—Ç—É—Å:** –í requirements.txt, –Ω–æ 0 –≤—ã–∑–æ–≤–æ–≤ –≤ –∫–æ–¥–µ

**–ü–æ—á–µ–º—É –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- Pydantic –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç jsonschema
- Pydantic –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å FastAPI
- Pydantic —É–¥–æ–±–Ω–µ–µ (Python –∫–ª–∞—Å—Å—ã vs JSON —Å—Ö–µ–º—ã)

**–ú–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å:** ‚úÖ –î–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ requirements.txt

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** jsonschema —É—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–∞–∫–µ—Ç–∞ (–≤–æ–∑–º–æ–∂–Ω–æ openai –∏–ª–∏ httpx)

---

## üîÑ –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–∏–º–µ—Ä: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```python
# 1. HTTP Request –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ POST /new
curl -X POST https://skripkahack.ru/new -d '{
  "url": "jdbc:trino://localhost:8080?catalog=mydb",
  "ddl": [{"statement": "CREATE TABLE mydb.public.users (...)"}],
  "queries": [{"queryid": "q1", "query": "SELECT * FROM mydb.public.users"}]
}'

# 2. FastAPI + Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è
@app.post("/new", response_model=TaskCreateResponse)
async def create_optimization_task(request: OptimizationRequest):
    ‚Üì
    OptimizationRequest –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç:
    ‚úÖ url: str (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å jdbc:)
    ‚úÖ ddl: List[Dict] (–µ—Å—Ç—å statement)
    ‚úÖ queries: List[Dict] (–µ—Å—Ç—å queryid, query, runquantity)

# 3. Task Manager —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
task = Task(request=request)  # ‚Üê Pydantic –º–æ–¥–µ–ª—å
‚Üì
task_id –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è (UUID)
status = RUNNING
–ó–∞–¥–∞—á–∞ –≤ –æ—á–µ—Ä–µ–¥—å

# 4. LLM Analyzer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

  # 4.1. –ü–∞—Ä—Å–∏–Ω–≥ DDL (SQLglot)
  ddl = "CREATE TABLE mydb.public.users (id INT, name VARCHAR)"
  ‚Üì
  parsed = sqlglot.parse_one(ddl)
  ‚Üì
  table_name = parsed.find(sqlglot.exp.Table).name  # ‚Üí "users"
  columns = [(col.name, col.type) for col in parsed.find_all(sqlglot.exp.ColumnDef)]
  # ‚Üí [("id", "INT"), ("name", "VARCHAR")]
  
  # 4.2. LLM –∞–Ω–∞–ª–∏–∑
  llm_response = call_openai_api(...)
  ‚Üì
  strategy = JSON response
  
  # 4.3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ (SQLglot)
  query = "SELECT * FROM mydb.public.users"
  ‚Üì
  parsed = sqlglot.parse_one(query)
  ‚Üì
  # SELECT * ‚Üí –∫–æ–ª–æ–Ω–∫–∏
  select.expressions = [Column("id"), Column("name")]
  ‚Üì
  # –ó–∞–º–µ–Ω–∞ –ø—É—Ç–∏
  table.set("db", "optimized_20241019")
  ‚Üì
  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ LIMIT
  parsed = parsed.limit(10000)
  ‚Üì
  optimized = parsed.sql()
  # ‚Üí "SELECT id, name FROM mydb.optimized_20241019.users LIMIT 10000"
  
  # 4.4. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (Pydantic)
  result = OptimizationResult(
      ddl=[...],
      migrations=[...],
      queries=[{"queryid": "q1", "query": optimized}]
  )
  ‚Üì
  Pydantic –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚úÖ

# 5. –í–æ–∑–≤—Ä–∞—Ç (Pydantic + FastAPI)
response = TaskResultResponse.from_optimization_result(result)
‚Üì
FastAPI —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤ JSON –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚Üì
HTTP 200 OK {"ddl": [...], "migrations": [...], "queries": [...]}
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ù–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (5 —Ç–∞–±–ª–∏—Ü, 10 –∑–∞–ø—Ä–æ—Å–æ–≤):

| –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –û–ø–µ—Ä–∞—Ü–∏–π | –í—Ä–µ–º—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|----------|-------|------------|
| **Pydantic** | 3-5 | < 5 –º—Å | –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ |
| **SQLglot** | ~45 | ~145 –º—Å | –ü–∞—Ä—Å–∏–Ω–≥ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL |
| **sqlparse** | 0 | 0 –º—Å | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| **jsonschema** | 0 | 0 –º—Å | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |

**–ò—Ç–æ–≥–æ:** Pydantic + SQLglot = ~150 –º—Å –Ω–∞ –∑–∞–¥–∞—á—É

---

## üõ†Ô∏è –ú–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ?

### sqlparse

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip show sqlparse

# –ï—Å–ª–∏ –Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
pip uninstall sqlparse

# –£–±—Ä–∞—Ç—å –∏–∑ requirements.txt
sed -i '/sqlparse/d' requirements.txt
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚ö†Ô∏è –û—Å—Ç–∞–≤–∏—Ç—å (–ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è, –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è)

### jsonschema

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—Ç–æ –∑–∞–≤–∏—Å–∏—Ç
pip show jsonschema

# Name: jsonschema
# Required-by: openai
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚ùå –ù–ï —É–¥–∞–ª—è—Ç—å (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø–∞–∫–µ—Ç–∞ openai)

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HTTP Request ‚îÇ (POST /new —Å JSON)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. PYDANTIC      ‚îÇ ‚Üê –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚îÇ OptimizationReq  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è OK
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Task Manager  ‚îÇ ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (Pydantic Task)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. LLM Analyzer  ‚îÇ
‚îÇ                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  SQLglot     ‚îÇ ‚îÇ ‚Üê –ü–∞—Ä—Å–∏–Ω–≥ DDL (—Ç–∞–±–ª–∏—Ü—ã, –∫–æ–ª–æ–Ω–∫–∏)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ        ‚îÇ         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  LLM Call    ‚îÇ ‚îÇ ‚Üê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ        ‚îÇ         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  SQLglot     ‚îÇ ‚îÇ ‚Üê –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ ‚îÇ  (x10-20)    ‚îÇ ‚îÇ   (SELECT *, LIMIT, –ø—É—Ç–∏, –∞–Ω–∞–ª–∏–∑)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ        ‚îÇ         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  Pydantic    ‚îÇ ‚îÇ ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ OptimizationResult
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ result –≥–æ—Ç–æ–≤
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. PYDANTIC      ‚îÇ ‚Üê –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
‚îÇ TaskResultResp   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è OK
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HTTP Response    ‚îÇ (JSON)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –≠—Ç–∞–ø | –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ó–∞—á–µ–º |
|------|------------|--------------|-------|
| **–í—Ö–æ–¥** | Pydantic | ‚úÖ | –í–∞–ª–∏–¥–∞—Ü–∏—è request body |
| **–ü–∞—Ä—Å–∏–Ω–≥ DDL** | SQLglot | ‚úÖ | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü |
| **LLM –∞–Ω–∞–ª–∏–∑** | OpenAI | ‚úÖ | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL** | SQLglot | ‚úÖ | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **–ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** | SQLglot | ‚úÖ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Ç–∏—Ü–∏–π/JOIN |
| **–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** | Pydantic | ‚úÖ | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö |
| **–í—ã—Ö–æ–¥** | Pydantic | ‚úÖ | –í–∞–ª–∏–¥–∞—Ü–∏—è response body |

---

## üéØ –í—ã–≤–æ–¥—ã

### ‚úÖ –†–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–∫—Ä–∏—Ç–∏—á–Ω—ã):

1. **Pydantic** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–µ –∏ –≤—ã—Ö–æ–¥–µ
2. **SQLglot** - –ø–∞—Ä—Å–∏–Ω–≥ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL

### ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å):

1. **sqlparse** - –Ω–µ –Ω—É–∂–µ–Ω (–µ—Å—Ç—å SQLglot)
2. **jsonschema** - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å openai (—É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è)

### üîÑ –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

```
1. Pydantic (–≤—Ö–æ–¥) ‚Üí
2. SQLglot (DDL) ‚Üí
3. LLM (–∞–Ω–∞–ª–∏–∑) ‚Üí
4. SQLglot (SQL –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è) ‚Üí
5. Pydantic (–≤—ã—Ö–æ–¥)
```

**–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:** Pydantic ~5 –º—Å + SQLglot ~145 –º—Å = **~150 –º—Å –Ω–∞ –∑–∞–¥–∞—á—É**

---

**–í—ã–≤–æ–¥:** –ò–∑ 4 –±–∏–±–ª–∏–æ—Ç–µ–∫ **—Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è 2** (Pydantic + SQLglot)

